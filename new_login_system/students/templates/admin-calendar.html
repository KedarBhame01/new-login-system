<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar Management - Admin</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #4e73df;
            --success-color: #1cc88a;
            --info-color: #36b9cc;
            --warning-color: #f6c23e;
            --danger-color: #e74a3b;
            --light-color: #f8f9fc;
        }
        
        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--light-color);
        }
        
        .sidebar {
            background: linear-gradient(180deg, #e74a3b 10%, #c92a2a 100%);
            min-height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            z-index: 1000;
        }
        
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 1rem 1.5rem;
            border-radius: 0.35rem;
            margin: 0.2rem 1rem;
            transition: all 0.3s;
        }
        
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        
        .card {
            border: none;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            border-radius: 0.35rem;
        }
        
        .fc-event {
            cursor: pointer;
        }
        
        .event-type-academic { background-color: #4e73df; border-color: #4e73df; }
        .event-type-exam { background-color: #e74a3b; border-color: #e74a3b; }
        .event-type-holiday { background-color: #1cc88a; border-color: #1cc88a; }
        .event-type-meeting { background-color: #f6c23e; border-color: #f6c23e; color: #000; }
        
        @media (max-width: 768px) {
            .sidebar { width: 100%; position: relative; }
            .main-content { margin-left: 0; }
        }
    </style>
</head>
<body>
    <!-- Admin Sidebar -->
    <nav class="sidebar">
        <div class="text-center py-4">
            <h4 class="text-white mb-0">
                <i class="fas fa-user-shield"></i> SMS
            </h4>
            <small class="text-white-50">Admin Panel</small>
        </div>
        
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link" href="/main_admin/dashboard/">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/main_admin/students/">
                    <i class="fas fa-users"></i> Students
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/main_admin/attendance/">
                    <i class="fas fa-calendar"></i> Attendance
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/main_admin/fees/">
                    <i class="fas fa-dollar-sign"></i> Fee Management
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="/main_admin/calender/">
                    <i class="fas fa-calendar-alt"></i> Calendar
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/main_admin/homework/">
                    <i class="fas fa-tasks"></i> Homework
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/main_admin/notice/">
                    <i class="fas fa-bullhorn"></i> Notices
                </a>
            </li>
            <li class="nav-item mt-3">
                <a class="nav-link text-warning" href="#" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </li>
        </ul>
    </nav>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Topbar -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0 text-gray-800">Calendar Management</h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#eventModal">
                <i class="fas fa-plus"></i> Add Event
            </button>
        </div>
        
        <!-- Alert Container -->
        <div id="alert-container"></div>
        
        <!-- Calendar Stats -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-primary shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Events</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-events">0</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-calendar fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-success shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">This Month</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="month-events">0</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-calendar-day fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-warning shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Upcoming</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="upcoming-events">0</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-clock fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-info shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Today</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="today-events">0</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-star fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Calendar -->
        <div class="card">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-calendar-alt"></i> Academic Calendar
                </h6>
            </div>
            <div class="card-body">
                <div id="calendar"></div>
            </div>
        </div>
    </div>

    <!-- Event Modal -->
    <div class="modal fade" id="eventModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add/Edit Event</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="eventForm">
                    <div class="modal-body">
                        <input type="hidden" id="event-id">
                        
                        <div class="mb-3">
                            <label for="event-title" class="form-label">Event Title</label>
                            <input type="text" class="form-control" id="event-title" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="event-description" class="form-label">Description</label>
                            <textarea class="form-control" id="event-description" rows="3"></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="event-start" class="form-label">Start Date</label>
                                    <input type="datetime-local" class="form-control" id="event-start" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="event-end" class="form-label">End Date</label>
                                    <input type="datetime-local" class="form-control" id="event-end">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="event-type" class="form-label">Event Type</label>
                            <select class="form-select" id="event-type" required>
                                <option value="">Select Type</option>
                                <option value="academic">Academic</option>
                                <option value="exam">Exam</option>
                                <option value="holiday">Holiday</option>
                                <option value="meeting">Meeting</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="all-day">
                                <label class="form-check-label" for="all-day">All Day Event</label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="delete-event-btn" style="display: none;">Delete</button>
                        <button type="submit" class="btn btn-primary">Save Event</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- FullCalendar JS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    
    <script>
        let calendar;
        let events = [];
        
        // API call function
        async function apiCall(url, method = 'GET', data = null) {
            const headers = { 'Content-Type': 'application/json' };
            const config = { method, headers };
            
            if (data && method !== 'GET') {
                config.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(url, config);
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || 'API call failed');
                }
                
                return result;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }
        
        // Show alert
        function showAlert(message, type = 'info') {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.getElementById('alert-container').innerHTML = alertHtml;
            
            setTimeout(() => {
                const alert = document.querySelector('.alert');
                if (alert) alert.remove();
            }, 5000);
        }
        
        // Initialize calendar
        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar');
            
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                selectable: true,
                selectMirror: true,
                dayMaxEvents: true,
                weekends: true,
                events: events,
                
                select: function(selectionInfo) {
                    openEventModal(null, selectionInfo.start, selectionInfo.end);
                },
                
                eventClick: function(clickInfo) {
                    openEventModal(clickInfo.event);
                },
                
                editable: true,
                droppable: true,
                
                eventDrop: function(eventDropInfo) {
                    updateEvent(eventDropInfo.event);
                },
                
                eventResize: function(eventResizeInfo) {
                    updateEvent(eventResizeInfo.event);
                }
            });
            
            calendar.render();
        }
        
        // Load events
        async function loadEvents() {
            try {
                // Try multiple endpoints
                const endpoints = [
                    '/main_admin/calender/all/',
                    '/calendar/all/',
                    '/events/all/'
                ];
                
                let result = null;
                for (const endpoint of endpoints) {
                    try {
                        result = await apiCall(endpoint);
                        if (result.status === 'success' && result.data) {
                            events = result.data.map(event => ({
                                id: event.id,
                                title: event.title,
                                start: event.start_date || event.date,
                                end: event.end_date,
                                description: event.description,
                                type: event.type || 'academic',
                                className: `event-type-${event.type || 'academic'}`,
                                allDay: event.all_day || false
                            }));
                            break;
                        }
                    } catch (error) {
                        continue;
                    }
                }
                
                if (!events || events.length === 0) {
                    generateDemoEvents();
                }
                
                updateStats();
                calendar.removeAllEvents();
                calendar.addEventSource(events);
                
            } catch (error) {
                console.error('Error loading events:', error);
                generateDemoEvents();
                showAlert('Using demo data - unable to load real calendar events', 'warning');
            }
        }
        
        // Generate demo events
        function generateDemoEvents() {
            const today = new Date();
            events = [
                {
                    id: 1,
                    title: 'Mid-Semester Exams Begin',
                    start: new Date(today.getFullYear(), today.getMonth(), today.getDate() + 5).toISOString().split('T')[0],
                    type: 'exam',
                    className: 'event-type-exam',
                    allDay: true
                },
                {
                    id: 2,
                    title: 'Parent-Teacher Meeting',
                    start: new Date(today.getFullYear(), today.getMonth(), today.getDate() + 10).toISOString().split('T')[0],
                    type: 'meeting',
                    className: 'event-type-meeting',
                    allDay: true
                },
                {
                    id: 3,
                    title: 'Sports Day',
                    start: new Date(today.getFullYear(), today.getMonth(), today.getDate() + 15).toISOString().split('T')[0],
                    type: 'academic',
                    className: 'event-type-academic',
                    allDay: true
                },
                {
                    id: 4,
                    title: 'Holiday - Independence Day',
                    start: new Date(today.getFullYear(), today.getMonth(), today.getDate() + 20).toISOString().split('T')[0],
                    type: 'holiday',
                    className: 'event-type-holiday',
                    allDay: true
                }
            ];
        }
        
        // Update statistics
        function updateStats() {
            const total = events.length;
            const today = new Date().toISOString().split('T')[0];
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const thisMonth = events.filter(event => {
                const eventDate = new Date(event.start);
                return eventDate.getMonth() === currentMonth && eventDate.getFullYear() === currentYear;
            }).length;
            
            const todayEvents = events.filter(event => 
                event.start.split('T')[0] === today
            ).length;
            
            const upcoming = events.filter(event => 
                new Date(event.start) > new Date()
            ).length;
            
            document.getElementById('total-events').textContent = total;
            document.getElementById('month-events').textContent = thisMonth;
            document.getElementById('today-events').textContent = todayEvents;
            document.getElementById('upcoming-events').textContent = upcoming;
        }
        
        // Open event modal
        function openEventModal(event = null, startDate = null, endDate = null) {
            const modal = new bootstrap.Modal(document.getElementById('eventModal'));
            const form = document.getElementById('eventForm');
            
            // Reset form
            form.reset();
            document.getElementById('event-id').value = '';
            document.getElementById('delete-event-btn').style.display = 'none';
            
            if (event) {
                // Edit existing event
                document.getElementById('event-id').value = event.id;
                document.getElementById('event-title').value = event.title;
                document.getElementById('event-description').value = event.extendedProps.description || '';
                document.getElementById('event-start').value = formatDateForInput(event.start);
                document.getElementById('event-end').value = event.end ? formatDateForInput(event.end) : '';
                document.getElementById('event-type').value = event.extendedProps.type || 'academic';
                document.getElementById('all-day').checked = event.allDay;
                document.getElementById('delete-event-btn').style.display = 'inline-block';
                
                document.querySelector('.modal-title').textContent = 'Edit Event';
            } else {
                // New event
                if (startDate) {
                    document.getElementById('event-start').value = formatDateForInput(startDate);
                }
                if (endDate) {
                    document.getElementById('event-end').value = formatDateForInput(endDate);
                }
                document.querySelector('.modal-title').textContent = 'Add Event';
            }
            
            modal.show();
        }
        
        // Format date for input
        function formatDateForInput(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const hours = String(d.getHours()).padStart(2, '0');
            const minutes = String(d.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }
        
        // Save event
        async function saveEvent(eventData) {
            try {
                const eventId = document.getElementById('event-id').value;
                const url = eventId ? `/main_admin/calender/update/${eventId}/` : '/main_admin/calender/add/';
                const method = eventId ? 'PUT' : 'POST';
                
                const result = await apiCall(url, method, eventData);
                
                if (result.status === 'success') {
                    showAlert('Event saved successfully!', 'success');
                    loadEvents();
                    bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                } else {
                    // If API fails, update locally for demo
                    if (eventId) {
                        const index = events.findIndex(e => e.id == eventId);
                        if (index !== -1) {
                            events[index] = { ...events[index], ...eventData };
                        }
                    } else {
                        events.push({
                            id: Date.now(),
                            ...eventData,
                            className: `event-type-${eventData.type}`
                        });
                    }
                    
                    calendar.removeAllEvents();
                    calendar.addEventSource(events);
                    updateStats();
                    
                    showAlert('Event saved locally (demo mode)', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                }
            } catch (error) {
                console.error('Error saving event:', error);
                showAlert('Error saving event', 'danger');
            }
        }
        
        // Delete event
        async function deleteEvent() {
            const eventId = document.getElementById('event-id').value;
            
            if (!eventId || !confirm('Are you sure you want to delete this event?')) {
                return;
            }
            
            try {
                const result = await apiCall(`/main_admin/calender/delete/${eventId}/`, 'DELETE');
                
                if (result.status === 'success') {
                    showAlert('Event deleted successfully!', 'success');
                } else {
                    // Delete locally for demo
                    events = events.filter(e => e.id != eventId);
                    calendar.removeAllEvents();
                    calendar.addEventSource(events);
                    updateStats();
                    showAlert('Event deleted locally (demo mode)', 'success');
                }
                
                bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                loadEvents();
                
            } catch (error) {
                console.error('Error deleting event:', error);
                showAlert('Error deleting event', 'danger');
            }
        }
        
        // Form submission
        document.getElementById('eventForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const eventData = {
                title: document.getElementById('event-title').value,
                description: document.getElementById('event-description').value,
                start: document.getElementById('event-start').value,
                end: document.getElementById('event-end').value || null,
                type: document.getElementById('event-type').value,
                allDay: document.getElementById('all-day').checked
            };
            
            saveEvent(eventData);
        });
        
        // Delete event button
        document.getElementById('delete-event-btn').addEventListener('click', deleteEvent);
        
        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.clear();
                window.location.href = '/student/login/';
            }
        }
        
        // Check authentication
        function checkAuth() {
            const userType = localStorage.getItem('user_type');
            if (userType !== 'admin') {
                window.location.href = '/student/login/';
                return false;
            }
            return true;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            if (checkAuth()) {
                initializeCalendar();
                loadEvents();
            }
        });
    </script>
</body>
</html>